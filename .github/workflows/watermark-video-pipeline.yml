name: Watermark Video Pipeline
















































}  ]    }      "enabled": true      "parent_topic_param": "CYBERSECURITY_2025_PARENT_TOPIC",      "zoom_email": "itdefined.org4@gmail.com",      "zoom_account": "Z4",      "zoom_id": "81682381743",      "batch_id": "41",      "itd_zoom_id": "20260112",      "batch_name": "itd_cysec_jan_2026",      "course_id": "49",    {    },      "enabled": false      "parent_topic_param": "NGO_DS_2025_PARENT_TOPIC",      "zoom_email": "itdefined.org2@gmail.com",      "zoom_account": "Z2",      "zoom_id": "83380367141",      "batch_id": "43",      "itd_zoom_id": "20251118",      "batch_name": "itd_ds_nov_2025",      "course_id": "51",    {    },      "enabled": false      "parent_topic_param": "DEVOPS_JULY_2025_PARENT_TOPIC",      "zoom_email": "itdefined.org4@gmail.com",      "zoom_account": "Z4",      "zoom_id": "83784274158",      "batch_id": "35",      "itd_zoom_id": "28062025",      "batch_name": "itd_devops_july_2025",      "course_id": "2",    {    },      "enabled": true      "parent_topic_param": "DEVOPS_DEC_2025_PARENT_TOPIC",      "zoom_email": "itdefined.org2@gmail.com",      "zoom_account": "Z2",      "zoom_id": "85908177452",      "batch_id": "40",      "itd_zoom_id": "20251215",      "batch_name": "itd_devops_dec_2025",      "course_id": "2",    {on:
  workflow_dispatch:
    inputs:
      bucket_name:
        description: 'S3 Bucket Name'
        required: true
        default: 'class-recordings-itdefined'
      batch_name:
        description: 'Batch Name (e.g., itd_cysec_jan_2026)'
        required: true
      itd_webinar_id:
        description: 'ITD Webinar ID'
        required: true
      zoom_account:
        description: 'Zoom Account'
        required: true
      topic:
        description: 'Topic'
        required: true
      course_id:
        description: 'Course ID'
        required: true
      batch_id:
        description: 'Batch ID'
        required: true
      parent_topic:
        description: 'Parent Topic'
        required: true
      webinar_id:
        description: 'Webinar ID'
        required: true
      webinar_email:
        description: 'Webinar Email'
        required: true
      class_date:
        description: 'Class Date (YYYYMMDD)'
        required: true
      s3_delete_original:
        description: 'Delete from S3 Original Bucket'
        type: boolean
        default: false
      delete_local_videos:
        description: 'Delete Local Videos After Processing'
        type: boolean
        default: true
      delete_attendance:
        description: 'Delete Existing Attendance'
        type: boolean
        default: false
      delete_class:
        description: 'Delete Existing Class'
        type: boolean
        default: false
      s3_delete_watermark:
        description: 'Delete from S3 Watermark Bucket'
        type: boolean
        default: false
      use_s3_original:
        description: 'Use Original Video from S3'
        type: boolean
        default: false
      vemio_delete:
        description: 'Delete Existing Vimeo Video'
        type: boolean
        default: false

env:
  AWS_REGION: ap-south-1
  # Set all environment variables at job level - cleaner and available to all steps
  PGHOST: ${{ secrets.DB_HOST }}
  PGPORT: ${{ secrets.DB_PORT }}
  PGDATABASE: ${{ secrets.DB_NAME }}
  PGUSER: ${{ secrets.DB_USER }}
  PGPASSWORD: ${{ secrets.DB_PASSWORD }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_DEFAULT_REGION: ap-south-1
  VIMEO_ACCESS_TOKEN: ${{ secrets.VIMEO_ACCESS_TOKEN }}
  VIMEO_CLIENT_ID: ${{ secrets.VIMEO_CLIENT_ID }}
  VIMEO_CLIENT_SECRET: ${{ secrets.VIMEO_CLIENT_SECRET }}
  Z2_AI: ${{ secrets.ZOOM_Z2_ACCOUNT_ID }}
  Z2_CI: ${{ secrets.ZOOM_Z2_CLIENT_ID }}
  Z2_CS: ${{ secrets.ZOOM_Z2_CLIENT_SECRET }}
  Z4_AI: ${{ secrets.ZOOM_Z4_ACCOUNT_ID }}
  Z4_CI: ${{ secrets.ZOOM_Z4_CLIENT_ID }}
  Z4_CS: ${{ secrets.ZOOM_Z4_CLIENT_SECRET }}

jobs:
  watermark-and-upload:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Decrypt sensitive scripts
      env:
        ENCRYPTION_KEY: ${{ secrets.SCRIPTS_ENCRYPTION_KEY }}
      run: |
        cd github_actions
        ./bootstrap.sh run
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg postgresql-client
    
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install boto3 vimeo psycopg2-binary requests
    
    - name: Make scripts executable
      run: |
        chmod +x github_actions/scripts/*
    
    - name: Test Database Connection
      run: |
        psql -h "$PGHOST" -p "$PGPORT" -U "$PGUSER" -d "$PGDATABASE" -c "SELECT 1;" || {
          echo "ERROR: Database connection failed"
          exit 1
        }
        echo "âœ“ Database connection successful"
    
    - name: Run Watermark Video Pipeline
      run: |
        ./github_actions/scripts/watermark_pipeline.sh \
          "${{ github.event.inputs.bucket_name }}" \
          "${{ github.event.inputs.batch_name }}" \
          "${{ github.event.inputs.itd_webinar_id }}" \
          "${{ github.event.inputs.zoom_account }}" \
          "${{ github.event.inputs.topic }}" \
          "${{ github.event.inputs.course_id }}" \
          "${{ github.event.inputs.batch_id }}" \
          "${{ github.event.inputs.parent_topic }}" \
          "${{ github.event.inputs.webinar_id }}" \
          "${{ github.event.inputs.webinar_email }}" \
          "${{ github.event.inputs.class_date }}" \
          "${{ github.event.inputs.s3_delete_original }}" \
          "${{ github.event.inputs.delete_local_videos }}" \
          "${{ github.event.inputs.delete_attendance }}" \
          "false" \
          "${{ github.event.inputs.delete_class }}" \
          "${{ github.event.inputs.s3_delete_watermark }}" \
          "${{ github.event.inputs.use_s3_original }}" \
          "$VIMEO_ACCESS_TOKEN" \
          "$VIMEO_CLIENT_ID" \
          "$VIMEO_CLIENT_SECRET" \
          "${{ github.event.inputs.vemio_delete }}"
    
    - name: Upload artifacts (if failed)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: logs-${{ github.event.inputs.batch_name }}-${{ github.event.inputs.class_date }}
        path: |
          ~/.tmp/${{ github.event.inputs.batch_name }}/*.log
          ~/.tmp/${{ github.event.inputs.batch_name }}/*.txt
        retention-days: 7
    
    - name: Cleanup local videos
      if: always()
      run: |
        rm -rf ~/.tmp/${{ github.event.inputs.batch_name }}/*.mp4
