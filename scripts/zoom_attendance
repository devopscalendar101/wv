#!/usr/bin/env python3
import os
import sys
import json
import time
import requests
import urllib3
import pandas as pd
from datetime import datetime
from time import gmtime, strftime
from pprint import pprint

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# Date Handling
def get_class_date():
    if len(sys.argv) >= 7:
        try:
            return datetime.strptime(sys.argv[6], "%Y-%m-%d").date()
        except ValueError:
            print("❌ Invalid date format. Use YYYY-MM-DD.")
            sys.exit(1)
    else:
        input_date = input("Enter class date (YYYY-MM-DD): ").strip()
        try:
            return datetime.strptime(input_date, "%Y-%m-%d").date()
        except ValueError:
            print("❌ Invalid date format. Use YYYY-MM-DD.")
            sys.exit(1)
            
# Globals
class_date = get_class_date()
recording_date = class_date.strftime("%Y%m%d")
sql_formatted_timestamp = class_date.strftime('%Y-%m-%d')
# current_datetime = datetime.now()
# recording_date = current_datetime.strftime("%Y%m%d")
# sql_formatted_timestamp = current_datetime.strftime('%Y-%m-%d')
ur_users, total_candidates, total_registered, total_unregistered = [], 0, 0, 0
print_result = False

# Arguments
batch = sys.argv[1] if len(sys.argv) >= 2 else ''
webinar_id_source = sys.argv[2] if len(sys.argv) >= 3 else ''
zoom_acco = sys.argv[3] if len(sys.argv) >= 4 else ''
webinar_id_destination = sys.argv[4] if len(sys.argv) >= 5 else ''
email_id = sys.argv[5] if len(sys.argv) >= 6 else ''
csv_in = ''  # Set this if you plan to use CSV input


            
def get_access_token(zoom_account):
    creds = {
        "Z1": ("Z1_AI", "Z1_CI", "Z1_CS"),
        "Z2": ("Z2_AI", "Z2_CI", "Z2_CS"),
        "Z3": ("Z3_AI", "Z3_CI", "Z3_CS"),
        "Z4": ("Z4_AI", "Z4_CI", "Z4_CS"),
    }.get(zoom_account)

    if not creds:
        return None

    account_id, client_id, client_secret = (os.environ.get(x) for x in creds)
    url = f"https://zoom.us/oauth/token?grant_type=account_credentials&account_id={account_id}"
    res = requests.post(url, data={'grant_type': 'client_credentials'},
                        verify=False, auth=(client_id, client_secret))
    return res.json().get('access_token') if res.status_code == 200 else None


def authorization_token():
    res = requests.post("https://itdefined.org/registration/drf/login/", data={
        "email": os.environ.get('ITD_USER'),
        "password": os.environ.get('ITD_PASS'),
    })
    return res.json().get('token')


auth_token = authorization_token()


def send_data(email, duration, description, datein, tduration, extra_time='00:00'):
    global total_candidates, total_registered, total_unregistered

    total_candidates += 1
    headers = {'Authorization': f'Token {auth_token}', 'Content-Type': 'application/x-www-form-urlencoded'}

    duration_final = (
        f"Attended: {duration}Hrs\t(Class: {tduration} Et: {extra_time})"
        if extra_time != '00:00' else f"{duration} / {tduration}"
    )

    form_data = {
        "webinar_id": webinar_id_destination,
        "email": email,
        "date": datein,
        "duration": duration_final,
        "number_of_times_connected": len(description),
        "raw_data": json.dumps(description)
    }

    res = requests.post("https://itdefined.org/course/drf/attendance/", data=form_data, headers=headers)
    if res.status_code == 200:
        total_registered += 1
    else:
        total_unregistered += 1
        ur_users.append(email)
        print(f"            {total_unregistered}) Failed: {email} {duration} {tduration}")


def get_participants(meeting_id, zoom_account):
    token = get_access_token(zoom_account)
    if not token:
        return {}
    url = f'https://api.zoom.us/v2/past_meetings/{meeting_id}/participants?page_size=300'
    headers = {'Authorization': f'Bearer {token}'}
    return requests.get(url, headers=headers, verify=False).json()


def get_attendance_data(participants, email):
    return [p for p in participants if p['user_email'] == email]


def get_total_recording_time(webinar_id, zoom_account):
    token = get_access_token(zoom_account)
    if not token:
        return 0

    headers = {'Authorization': f'Bearer {token}'}
    url = f'https://api.zoom.us/v2/past_meetings/{webinar_id}/instances'
    res = requests.get(url, headers=headers)
    if res.status_code != 200:
        return 0

    recordings = res.json().get('meetings', [])
    all_recordings = []

    for rec in recordings:
        rec_url = f'https://api.zoom.us/v2/meetings/{rec["uuid"]}/recordings'
        r = requests.get(rec_url, headers=headers)
        files = r.json().get('recording_files', [])
        for f in files:
            if f['file_type'] == 'MP4':
                f.update({
                    'recording_start_date': f['recording_start'].split('T')[0],
                    'recording_start': f['recording_start'],
                    'recording_end': f['recording_end']
                })
                all_recordings.append(f)

    if not all_recordings:
        return 0

    latest = sorted(all_recordings, key=lambda x: x['recording_start_date'], reverse=True)[0]
    if latest['recording_start_date'].replace("-", "") == recording_date:
        start = datetime.strptime(latest['recording_start'], '%Y-%m-%dT%H:%M:%SZ')
        end = datetime.strptime(latest['recording_end'], '%Y-%m-%dT%H:%M:%SZ')
        return int((end - start).total_seconds())

    return 0


def main():
    global print_result

    if not (webinar_id_source and zoom_acco):
        print("            --> Class Attendance not updated in itdefined.org ......")
        return

    if csv_in:
        df = pd.read_csv(csv_in)
        result = df.groupby(['User Email'])['Duration (Minutes)'].sum()
        resl_time = get_total_recording_time(webinar_id_source, zoom_acco) or result.get(email_id, 0) * 60
        date_part = csv_in.split("_")[3].split('.')[0]
        final_date = f'2024-01-{date_part}'
        print_result = True
        send_data(email_id, '02:00', '', final_date, strftime("%H:%M", gmtime(resl_time)))
        print("            --> Fetched Class attendance data from zoom ........")
        for email, duration in result.items():
            send_data(email, strftime("%H:%M", gmtime(duration * 60)), '', final_date, strftime("%H:%M", gmtime(resl_time)))
    else:
        data = get_participants(webinar_id_source, zoom_acco).get('participants', [])
        if not data:
            print("            --> No Class attendance data in zoom ........")
            return

        meeting_date = data[0]['join_time'].split('T')[0]
        if meeting_date != sql_formatted_timestamp:
            print("            --> No Class attendance today ........")
            return

        df = pd.DataFrame(data)
        result = df.groupby(['user_email'])['duration'].sum()
        resl_time = get_total_recording_time(webinar_id_source, zoom_acco)
        res = result.get(email_id, 0)
        res_diff = max(0, res - resl_time)

        totalm = strftime('%H:%M', gmtime(res))
        totalr = strftime('%H:%M', gmtime(resl_time))
        totald = strftime('%H:%M', gmtime(res_diff))

        print(f"\n            TOTAL MEETING: {totalm}")
        print(f"            TOTAL RECORDING: {totalr}")
        print_result = True

        send_data(email_id, totalm, '', meeting_date, totalr, totald)
        for email, duration in result.items():
            send_data(email, strftime("%H:%M", gmtime(duration)), get_attendance_data(data, email), meeting_date, totalr, totald)

    if print_result:
        print(f'\n            Total Attendees: {total_candidates}')
        print(f'            Total Registered: {total_registered}')
        print(f'            Total UnRegistered: {total_unregistered}')
        print(f'\n            Unregistered Users:')
        for i, user in enumerate(ur_users, 1):
            print(f'                {i}) {user}')
        print(f"\n            --> Updated class Attendance in itdefined.org ......")

if __name__ == "__main__":
    main()